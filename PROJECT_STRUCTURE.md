# é¡¹ç›®ç»“æ„è¯´æ˜

## ç›®å½•ç»“æ„

```
rl-trl/
â”œâ”€â”€ ğŸ“„ æ ¸å¿ƒæ–‡ä»¶
â”‚   â”œâ”€â”€ train_grpo.py           # GRPO è®­ç»ƒä¸»è„šæœ¬
â”‚   â”œâ”€â”€ eval_model.py           # æ¨¡å‹è¯„ä¼°è„šæœ¬
â”‚   â”œâ”€â”€ interactive_test.py     # äº¤äº’å¼æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_setup.py           # ç¯å¢ƒæµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ requirements.txt        # Python ä¾èµ–
â”‚
â”œâ”€â”€ ğŸ³ Docker ç›¸å…³
â”‚   â”œâ”€â”€ Dockerfile              # Docker é•œåƒé…ç½®
â”‚   â”œâ”€â”€ docker-compose.yml      # Docker Compose é…ç½®
â”‚   â”œâ”€â”€ .dockerignore           # Docker å¿½ç•¥æ–‡ä»¶
â”‚   â””â”€â”€ env.example             # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚
â”œâ”€â”€ âš™ï¸  é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ configs/
â”‚       â”œâ”€â”€ default.yaml        # é»˜è®¤è®­ç»ƒé…ç½®
â”‚       â””â”€â”€ custom.yaml         # è‡ªå®šä¹‰é…ç½®ç¤ºä¾‹
â”‚
â”œâ”€â”€ ğŸ”§ è„šæœ¬å·¥å…·
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ build.sh            # æ„å»º Docker é•œåƒ
â”‚       â”œâ”€â”€ run.sh              # è¿è¡Œå®¹å™¨
â”‚       â””â”€â”€ train.sh            # å¯åŠ¨è®­ç»ƒ
â”‚
â”œâ”€â”€ ğŸ“Š è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ outputs/                # è®­ç»ƒè¾“å‡ºå’Œ checkpoints
â”‚   â”œâ”€â”€ logs/                   # è®­ç»ƒæ—¥å¿—
â”‚   â”œâ”€â”€ data/                   # æ•°æ®ç¼“å­˜
â”‚   â””â”€â”€ checkpoints/            # æ¨¡å‹æ£€æŸ¥ç‚¹
â”‚
â”œâ”€â”€ ğŸ“š æ–‡æ¡£
â”‚   â”œâ”€â”€ README.md               # ä¸»æ–‡æ¡£
â”‚   â”œâ”€â”€ QUICKSTART.md           # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”‚   â”œâ”€â”€ PROJECT_STRUCTURE.md    # æœ¬æ–‡ä»¶
â”‚   â””â”€â”€ LICENSE                 # MIT è®¸å¯è¯
â”‚
â””â”€â”€ ğŸ› ï¸  å·¥å…·æ–‡ä»¶
    â”œâ”€â”€ Makefile                # Make å‘½ä»¤
    â””â”€â”€ .gitignore              # Git å¿½ç•¥æ–‡ä»¶
```

## æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒè®­ç»ƒæ–‡ä»¶

#### train_grpo.py
ä¸»è®­ç»ƒè„šæœ¬ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š
- åŠ è½½ Qwen3-32B æ¨¡å‹ï¼ˆä½¿ç”¨ Unslothï¼‰
- é…ç½® LoRA é€‚é…å™¨
- ä½¿ç”¨ TRL çš„ GRPO è®­ç»ƒæ–¹æ³•
- æ”¯æŒ 4-bit é‡åŒ–è®­ç»ƒ
- Wandb é›†æˆ
- è‡ªåŠ¨ä¿å­˜ checkpoints

å…³é”®å‚æ•°ï¼š
- `--config`: é…ç½®æ–‡ä»¶è·¯å¾„
- `--model`: æ¨¡å‹åç§°
- `--load_in_4bit`: å¯ç”¨ 4-bit é‡åŒ–
- `--resume`: æ¢å¤è®­ç»ƒ
- `--no_wandb`: ç¦ç”¨ Wandb

#### eval_model.py
æ¨¡å‹è¯„ä¼°è„šæœ¬ï¼Œæ”¯æŒï¼š
- åŠ è½½è®­ç»ƒåçš„æ¨¡å‹
- åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°
- è®¡ç®—å‡†ç¡®ç‡ç­‰æŒ‡æ ‡
- å±•ç¤ºæ ·ä¾‹è¾“å‡º

#### interactive_test.py
äº¤äº’å¼å¯¹è¯æµ‹è¯•ï¼Œç‰¹æ€§ï¼š
- å®æ—¶å¯¹è¯æµ‹è¯•
- å¤šè½®å¯¹è¯æ”¯æŒ
- å¯é…ç½®ç”Ÿæˆå‚æ•°
- å¯¹è¯å†å²ç®¡ç†

#### test_setup.py
ç¯å¢ƒæµ‹è¯•è„šæœ¬ï¼Œæ£€æŸ¥ï¼š
- Python åŒ…æ˜¯å¦å®Œæ•´å®‰è£…
- CUDA æ˜¯å¦å¯ç”¨
- GPU ä¿¡æ¯
- å¯é€‰åŒ…çŠ¶æ€

### é…ç½®æ–‡ä»¶

#### configs/default.yaml
é»˜è®¤é…ç½®ï¼Œé€‚ç”¨äºï¼š
- å•å¡ 4090/A6000
- 4-bit é‡åŒ– + LoRA-16
- Batch size 2 + Gradient accumulation 4
- çº¦ 20GB æ˜¾å­˜éœ€æ±‚

#### configs/custom.yaml
é«˜çº§é…ç½®ç¤ºä¾‹ï¼Œç‰¹æ€§ï¼š
- æ›´å¤§çš„ LoRA rank (32)
- æ›´é•¿çš„ä¸Šä¸‹æ–‡ (8K)
- æ›´å¤šçš„è®­ç»ƒè½®æ¬¡
- é€‚åˆ A100 ç­‰å¤§æ˜¾å­˜ GPU

### Docker æ–‡ä»¶

#### Dockerfile
åŸºäº `nvcr.io/nvidia/pytorch:25.11-py3`ï¼ŒåŒ…å«ï¼š
- CUDA 12.4 + cuDNN 9
- PyTorch 2.6+
- æ‰€æœ‰è®­ç»ƒä¾èµ–
- ä¼˜åŒ–çš„ç¼“å­˜é…ç½®

#### docker-compose.yml
ç®€åŒ–çš„ Docker å¯åŠ¨é…ç½®ï¼š
- GPU æ”¯æŒ
- å·æŒ‚è½½
- ç¯å¢ƒå˜é‡
- ç«¯å£æ˜ å°„

### è„šæœ¬å·¥å…·

#### scripts/build.sh
æ„å»º Docker é•œåƒï¼š
- ä½¿ç”¨ BuildKit ä¼˜åŒ–æ„å»º
- æ”¯æŒç¼“å­˜åŠ é€Ÿ
- è‡ªåŠ¨æ ‡ç­¾

#### scripts/run.sh
è¿è¡Œå®¹å™¨ï¼š
- GPU æ”¯æŒ
- è‡ªåŠ¨æŒ‚è½½ç›®å½•
- ç¯å¢ƒå˜é‡ä¼ é€’
- HuggingFace ç¼“å­˜å…±äº«

#### scripts/train.sh
å¯åŠ¨è®­ç»ƒï¼š
- é…ç½®æ–‡ä»¶æ”¯æŒ
- æ¢å¤è®­ç»ƒé€‰é¡¹
- Wandb æ§åˆ¶

### Makefile
ä¾¿æ·çš„å‘½ä»¤å¿«æ·æ–¹å¼ï¼š
- `make build`: æ„å»ºé•œåƒ
- `make run`: è¿è¡Œå®¹å™¨
- `make train`: å¼€å§‹è®­ç»ƒ
- `make eval`: è¯„ä¼°æ¨¡å‹
- `make test`: äº¤äº’æµ‹è¯•
- `make clean`: æ¸…ç†è¾“å‡º

## å·¥ä½œæµç¨‹

### 1. åˆå§‹è®¾ç½®
```bash
cd /home/zhlmmc/rl-trl
make build
```

### 2. å¼€å§‹è®­ç»ƒ
```bash
make run  # å¯åŠ¨å®¹å™¨
# åœ¨å®¹å™¨å†…ï¼š
make train
```

### 3. è¯„ä¼°å’Œæµ‹è¯•
```bash
make eval   # è¯„ä¼°
make test   # äº¤äº’æµ‹è¯•
```

## æ•°æ®æµ

```
HuggingFace Hub
    â†“
train_grpo.py åŠ è½½æ•°æ®é›† (trl-lib/gsm8k-grpo)
    â†“
GRPO Trainer è®­ç»ƒæ¨¡å‹
    â†“
outputs/qwen3-32b-grpo/
    â”œâ”€â”€ checkpoint-500/
    â”œâ”€â”€ checkpoint-1000/
    â””â”€â”€ final/
```

## æ˜¾å­˜ä½¿ç”¨

| ç»„ä»¶ | æ˜¾å­˜å ç”¨ |
|------|---------|
| æ¨¡å‹åŸºç¡€ (4-bit) | ~8GB |
| LoRA å‚æ•° | ~2GB |
| ä¼˜åŒ–å™¨çŠ¶æ€ | ~4GB |
| æ¿€æ´»å€¼ç¼“å­˜ | ~4GB |
| è®­ç»ƒæ‰¹æ¬¡ | ~2GB |
| **æ€»è®¡** | **~20GB** |

## æ‰©å±•å»ºè®®

### æ·»åŠ æ–°æ•°æ®é›†
1. åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ `dataset_name`
2. å¦‚éœ€è¦ï¼Œä¿®æ”¹ `reward_function`
3. é‡æ–°è®­ç»ƒ

### è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°
ç¼–è¾‘ `train_grpo.py` ä¸­çš„ `reward_function`ï¼š
```python
def reward_function(samples, prompts, outputs, **kwargs):
    # ä½ çš„è‡ªå®šä¹‰é€»è¾‘
    return rewards
```

### å¤š GPU è®­ç»ƒ
ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š
```yaml
# ä½¿ç”¨ DeepSpeed æˆ–åˆ†å¸ƒå¼è®­ç»ƒ
# è¯¦è§ TRL æ–‡æ¡£
```

## æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œ**ä¼šä¸‹è½½æ¨¡å‹ï¼ˆçº¦ 16GBï¼‰ï¼Œéœ€è¦æ—¶é—´
2. **HuggingFace ç¼“å­˜**åœ¨ `~/.cache/huggingface` ä¸­å…±äº«
3. **Checkpoints** å¯èƒ½å¾ˆå¤§ï¼Œå®šæœŸæ¸…ç†æ—§çš„
4. **Wandb æ—¥å¿—**éœ€è¦å…ˆ `wandb login`

## ç›¸å…³é“¾æ¥

- [TRL æ–‡æ¡£](https://huggingface.co/docs/trl)
- [Unsloth æ–‡æ¡£](https://github.com/unslothai/unsloth)
- [Qwen3 æ¨¡å‹å¡](https://huggingface.co/unsloth/Qwen3-32B)
- [GRPO è®ºæ–‡](https://arxiv.org/abs/2402.03300)
